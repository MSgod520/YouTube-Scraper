name: Build iOS IPA
on:
  workflow_dispatch: # 手动触发
jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
      - name: Install Dependencies
        working-directory: ./mobile_app
        run: |
          pip install flet
          pip install -r requirements.txt
      - name: Build Runner.app (Unsigned)
        working-directory: ./mobile_app
        run: |
          yes | flet build ipa --verbose
        env:
          CODE_SIGNING_ALLOWED: "NO"
          CODE_SIGNING_REQUIRED: "NO"
          CODE_SIGNING_IDENTITY: ""
      - name: Package Fake IPA
        working-directory: ./mobile_app
        run: |
          echo "Looking for Runner.app..."
          find . -name "Runner.app" -type d
          
          mkdir Payload
          # 在 mobile_app 目录下寻找 build 产物
          APP_PATH=$(find . -name "Runner.app" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: Runner.app not found!"
            exit 1
          fi
          
          echo "Found app at: $APP_PATH"
          cp -R "$APP_PATH" Payload/
          
          zip -r -y unsigned_app.ipa Payload/
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-release
          path: mobile_app/unsigned_app.ipa
